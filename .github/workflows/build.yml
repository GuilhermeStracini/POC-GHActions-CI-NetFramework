name: Build & Test .NET Framework
on: [push,  workflow_dispatch]

concurrency: 
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup_redis:
    name: Setup Redis
    runs-on: ubuntu-latest
    
    steps:
    
      - name: Redis Server in GitHub Actions
        uses: supercharge/redis-github-action@1.5.0

  build:
    name: Build
    runs-on: windows-latest
    needs: setup_redis

    steps:
    
      - name: Checkout Code
        uses: actions/checkout@v3
                    
      - name: Setup MSBuild Path
        uses: microsoft/setup-msbuild@v1.3
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: true
    
      - name: Setup Nuget
        uses: NuGet/setup-nuget@v1.1.1
        env:
          ACTIONS_ALLOW_UNSECURE_COMMANDS: true
          
      - name: Setup VSTest
        uses: darenm/Setup-VSTest@v1
        
      - name: Restore NuGet Packages
        run: nuget restore GHActionsCI.sln       
      
      - name: Build
        run: msbuild GHActionsCI.sln /p:Configuration=Release
        
      - name: Test
        run: vstest.console.exe .\Test\GHActionsCI.UnitTests\bin\Release\GHActionsCI.UnitTests.dll

      - name: Run
        run: Src\GHActionsCI\bin\Release\GHActionsCI.exe
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3.1.2
        with:
          name: release
          path: Src\GHActionsCI\bin\Release\
          
  deploy:
    name: Deploy
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download release
        uses: actions/download-artifact@v3
        with:
          name: release

      - name: Upload to test FTP
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ftp://ftp.dlptest.com/
          user: dlpuser
          password: rNrKYTX9g7z3RgJRmxWuGHbeu

  cleanup:
    name: Cleanup
    needs: deploy
    runs-on: ubuntu-latest
    steps:
      - name: Remove artifacts
        uses: geekyeggo/delete-artifact@v2
        with:
          name: "*"
